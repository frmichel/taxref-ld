@prefix rdf:            <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:           <http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:            <http://www.w3.org/2002/07/owl#>.
@prefix skos:           <http://www.w3.org/2004/02/skos/core#>.
@prefix skosxl:         <http://www.w3.org/2008/05/skos-xl#>.
@prefix xsd:            <http://www.w3.org/2001/XMLSchema#>.

@prefix bibo:           <http://purl.org/ontology/bibo/> .
@prefix dcat:           <http://www.w3.org/ns/dcat#>.
@prefix dce:            <http://purl.org/dc/elements/1.1/>.
@prefix dct:            <http://purl.org/dc/terms/>.
@prefix dwc:            <http://rs.tdwg.org/dwc/terms/> .
@prefix dwciri:         <http://rs.tdwg.org/dwc/iri/> .
@prefix foaf:           <http://xmlns.com/foaf/0.1/>.
@prefix prov:           <http://www.w3.org/ns/prov#>.
@prefix ro:             <http://purl.obolibrary.org/obo/>.
@prefix schema:         <http://schema.org/>.
@prefix tn:             <http://rs.tdwg.org/ontology/voc/TaxonName#>.
@prefix void:           <http://rdfs.org/ns/void#>.
@prefix wd:             <http://www.wikidata.org/entity/>.           # Wikibase entity
@prefix wdt:            <http://www.wikidata.org/prop/direct/>.      # truthy assertions

@prefix taxref:         <http://taxref.mnhn.fr/lod/>.
@prefix taxrefbgs:      <http://taxref.mnhn.fr/lod/bioGeoStatus/>.
@prefix taxrefhab:      <http://taxref.mnhn.fr/lod/habitat/>.
@prefix taxrefloc:      <http://taxref.mnhn.fr/lod/loc/>.
@prefix taxrefprop:     <http://taxref.mnhn.fr/lod/property/>.
@prefix taxrefrk:       <http://taxref.mnhn.fr/lod/taxrank/>.
@prefix taxrefstatus:   <http://taxref.mnhn.fr/lod/status/>.
@prefix taxrefspec:     <http://taxref.mnhn.fr/lod/specificity/>.

@prefix xrr:            <http://i3s.unice.fr/xr2rml#> .
@prefix rr:             <http://www.w3.org/ns/r2rml#> .
@prefix rml:            <http://semweb.mmlab.be/ns/rml#> .


# -------------------------------------------------------------------------
# Generate the classes for SOURCE TAXON with stage and/or sex
#
# Example of what we want to generatye
# <http://taxref.mnhn.fr/lod/taxon/123456_94a0e5df69173fafa8059af798f69eef0f8c7d13>
#  owl:equivalentClass [
#    owl:intersectionOf (
#        <http://taxref.mnhn.fr/lod/taxon/53668/14.0>
#        taxref:Organisms_in_larve_stage
#        taxref:femelle_Organisms
#    )
#  ].

<#SM_Source_Extd> a rr:SubjectMap;
    rr:template "http://taxref.mnhn.fr/lod/taxon/{$.taxon.id}_sha1({$.taxonStage}_{$.taxonSex})";
    rr:class owl:Class.

<#TPL_Source_intersectionOf_BN>
    rr:template "intersectionOf_{$.taxon.id}_{$.taxonStage}_{$.taxonSex}"; rr:termType rr:BlankNode.
    
<#TPL_Source_intersectionOf_list_BN>
    rr:template "list_{$.taxon.id}_{$.taxonStage}_{$.taxonSex}"; rr:termType rr:BlankNode.

<#TPL_Source_intersectionOf_sublist_BN>
    rr:template "intersectionOf_sublist_{$.taxon.id}_{$.taxonStage}_{$.taxonSex}"; rr:termType rr:BlankNode.    

# Stage and no sex
<#LS_Source_Extd_Stage> xrr:query """db.interactions.find({$and:[{'taxonStage': { $ne: ''}},{'taxonSex': ''}]})""".
<#SM_Source_Extd_Stage> a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Stage>;
    rr:subjectMap <#SM_Source_Extd>;
    rr:predicateObjectMap [ rr:predicate rdfs:label; rr:objectMap [ rr:template "{$.taxon.scientificName}, {$.taxonStage}"; rr:termType rr:Literal ]];
    rr:predicateObjectMap [ rr:predicate owl:equivalentClass; rr:objectMap <#TPL_Source_intersectionOf_BN> ].
<#TM_intersectionOf_Stage>
    xrr:logicalSource <#LS_Source_Extd_Stage>;
    rr:subjectMap <#TPL_Source_intersectionOf_BN>;
    rr:predicateObjectMap [ rr:predicate owl:intersectionOf; rr:objectMap <#TPL_Source_intersectionOf_list_BN> ].

# Sex and no stage
<#LS_Source_Extd_Sex> xrr:query """db.interactions.find({$and:[{'taxonStage': ''},{'taxonSex': { $ne: ''}}]})""".
<#SM_Source_Extd_Sex> a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Sex>;
    rr:subjectMap <#SM_Source_Extd>;
    rr:predicateObjectMap [ rr:predicate rdfs:label; rr:objectMap [ rr:template "{$.taxon.scientificName}, {$.taxonSex}"; rr:termType rr:Literal ]];
    rr:predicateObjectMap [ rr:predicate owl:equivalentClass; rr:objectMap <#TPL_Source_intersectionOf_BN> ].
<#TM_intersectionOf_Sex>
    xrr:logicalSource <#LS_Source_Extd_Sex>;
    rr:subjectMap <#TPL_Source_intersectionOf_BN>;
    rr:predicateObjectMap [ rr:predicate owl:intersectionOf; rr:objectMap <#TPL_Source_intersectionOf_list_BN> ].

# Stage and sex
<#LS_Source_Extd_Stage_Sex> xrr:query """db.interactions.find({$and:[{'taxonStage': { $ne: ''}},{'taxonSex': { $ne: ''}}]})""".
<#SM_Source_Extd_Stage_Sex> a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Stage_Sex>;
    rr:subjectMap <#SM_Source_Extd>;
    rr:predicateObjectMap [ rr:predicate rdfs:label; rr:objectMap [ rr:template "{$.taxon.scientificName}, {$.taxonStage}, {$.taxonSex}"; rr:termType rr:Literal ]];
    rr:predicateObjectMap [ rr:predicate owl:equivalentClass; rr:objectMap <#TPL_Source_intersectionOf_BN> ].
<#TM_intersectionOf_Stage_Sex>
    xrr:logicalSource <#LS_Source_Extd_Stage_Sex>;
    rr:subjectMap <#TPL_Source_intersectionOf_BN>;
    rr:predicateObjectMap [ rr:predicate owl:intersectionOf; rr:objectMap <#TPL_Source_intersectionOf_list_BN> ].


# The first element of the intersection is the taxon, the 2nd is the stage class
<#TM_Source_first_element_list_stage>
    a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Stage>;
    rr:subjectMap <#TPL_Source_intersectionOf_list_BN>;
    rr:predicateObjectMap [ rr:predicate rdf:type; rr:object rdf:List ];
    rr:predicateObjectMap [ rr:predicate rdf:first; rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/taxon/{$.taxon.id}" ]];
    rr:predicateObjectMap [
        rr:predicate rdf:rest ;
        rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/Organisms_in_{$.taxonStage}_stage"; rr:termType xrr:RdfList ];
    ].

# The first element of the intersection is the taxon, the 2nd is the sex class
<#TM_Source_first_element_list_sex>
    a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Sex>;
    rr:subjectMap <#TPL_Source_intersectionOf_list_BN>;
    rr:predicateObjectMap [ rr:predicate rdf:type; rr:object rdf:List ];
    rr:predicateObjectMap [ rr:predicate rdf:first; rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/taxon/{$.taxon.id}" ]];
    rr:predicateObjectMap [
        rr:predicate rdf:rest ;
        rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/{$.taxonSex}_Organisms"; rr:termType xrr:RdfList ];
    ].

# The first element of the intersection is the taxon, the 2nd is a sublist
<#TM_Source_first_element_list_stage_sex>
    a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Stage_Sex>;
    rr:subjectMap <#TPL_Source_intersectionOf_list_BN>;
    rr:predicateObjectMap [ rr:predicate rdf:type; rr:object rdf:List ];
    rr:predicateObjectMap [ rr:predicate rdf:first; rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/taxon/{$.taxon.id}" ]];
    rr:predicateObjectMap [
        rr:predicate rdf:rest ;
        rr:objectMap <#TPL_Source_intersectionOf_sublist_BN>;
    ].

# The sublist consists of 2 elements: the stage class and the sex class
<#TM_Source_second_and_third_elements_list>
    a rr:TriplesMap;
    xrr:logicalSource <#LS_Source_Extd_Stage_Sex>;
    rr:subjectMap <#TPL_Source_intersectionOf_sublist_BN>;
    rr:predicateObjectMap [ rr:predicate rdf:type; rr:object rdf:List ];
    rr:predicateObjectMap [
        rr:predicate rdf:first ;
        rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/Organisms_in_{$.taxonStage}_stage"; rr:termType rr:IRI ];
    ];
    rr:predicateObjectMap [
        rr:predicate rdf:rest ;
        rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/{$.taxonSex}_Organisms"; rr:termType xrr:RdfList ];
    ].

#
# -------------------------------------------------------------------------
# Generate the classes for TARGET TAXON with stage (there is no sex for target taxon)
#
# Example of what we want to generatye
# <http://taxref.mnhn.fr/lod/taxon/123456_94a0e5df69173fafa8059af798f69eef0f8c7d13>
#  owl:equivalentClass [
#    owl:intersectionOf (
#        <http://taxref.mnhn.fr/lod/taxon/53668/14.0>
#        taxref:Organisms_in_larve_stage
#    )
#  ].

<#SM_Target_Extd> a rr:SubjectMap;
    rr:template "http://taxref.mnhn.fr/lod/taxon/{$.target.id}_sha1({$.targetStage})";
    rr:class owl:Class.

<#TPL_Target_intersectionOf_BN>
    rr:template "intersectionOf_{$.target.id}_{$.targetStage}"; rr:termType rr:BlankNode.
    
<#TPL_Target_intersectionOf_list_BN>
    rr:template "list_{$.target.id}_{$.targetStage}"; rr:termType rr:BlankNode.

<#LS_Target_Extd_Stage> xrr:query """db.interactions.find({'targetStage': {$ne: ''}})""".
<#SM_Target_Extd_Stage> a rr:TriplesMap;
    xrr:logicalSource <#LS_Target_Extd_Stage>;
    rr:subjectMap <#SM_Target_Extd>;
    rr:predicateObjectMap [ rr:predicate rdfs:label; rr:objectMap [ rr:template "{$.target.scientificName}, {$.targetStage}"; rr:termType rr:Literal ]];
    rr:predicateObjectMap [ rr:predicate owl:equivalentClass; rr:objectMap <#TPL_Target_intersectionOf_BN> ].
<#TM_intersectionOf_Stage>
    xrr:logicalSource <#LS_Target_Extd_Stage>;
    rr:subjectMap <#TPL_Target_intersectionOf_BN>;
    rr:predicateObjectMap [ rr:predicate owl:intersectionOf; rr:objectMap <#TPL_Target_intersectionOf_list_BN> ].


# The first element of the intersection is the taxon, the 2nd is the stage class
<#TM_Target_first_element_list_stage>
    a rr:TriplesMap;
    xrr:logicalSource <#LS_Target_Extd_Stage>;
    rr:subjectMap <#TPL_Target_intersectionOf_list_BN>;
    rr:predicateObjectMap [ rr:predicate rdf:type; rr:object rdf:List ];
    rr:predicateObjectMap [ rr:predicate rdf:first; rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/taxon/{$.target.id}" ]];
    rr:predicateObjectMap [
        rr:predicate rdf:rest ;
        rr:objectMap [ rr:template "http://taxref.mnhn.fr/lod/Organisms_in_{$.targetStage}_stage"; rr:termType xrr:RdfList ];
    ].
